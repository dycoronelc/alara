generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum UserType {
  INSURER
  ALARA
}

enum AddressType {
  HOME
  WORK
  OTHER
}

enum IdType {
  CEDULA
  PASSPORT
  OTRO
}

enum InspectionStatus {
  SOLICITADA
  AGENDADA
  REALIZADA
  CANCELADA
  APROBADA
  RECHAZADA
}

enum Priority {
  NORMAL
  ALTA
}

enum DecisionStatus {
  PENDIENTE
  APROBADA
  RECHAZADA
}

enum CalendarProvider {
  INTERNAL
  GOOGLE
}

enum CalendarStatus {
  TENTATIVE
  CONFIRMED
  CANCELLED
}

enum DocumentType {
  SOLICITUD_PDF
  REPORTE_PDF
  AUTORIZACION
  INVESTIGACION
  EVIDENCIA
  OTRO
}

enum StorageProvider {
  S3
  MINIO
  LOCAL
}

enum ReportOutcome {
  PENDIENTE
  FAVORABLE
  NO_FAVORABLE
  INCONCLUSO
}

enum ReportFieldType {
  TEXT
  NUMBER
  DATE
  BOOL
  ENUM
  JSON
}

enum InvestigationSource {
  PUBLIC_RECORD
  SANCTIONS
  PEP
  NEWS
  CREDIT
  OTHER
}

enum RiskLevel {
  BAJO
  MEDIO
  ALTO
}

enum WorkflowProvider {
  N8N
}

enum WorkflowStatus {
  STARTED
  SUCCESS
  FAILED
}

enum NotificationChannel {
  IN_APP
  EMAIL
  SMS
  WHATSAPP
}

enum NotificationStatus {
  PENDING
  SENT
  FAILED
}

model Insurer {
  id         BigInt    @id @default(autoincrement())
  name       String    @db.VarChar(200)
  legal_id   String?   @db.VarChar(50)
  is_active  Boolean   @default(true)
  created_at DateTime  @default(now())
  updated_at DateTime? @updatedAt

  users               User[]
  insurer_clients     InsurerClient[]
  inspection_requests InspectionRequest[]
  documents           Document[]
  notifications       Notification[]

  @@unique([name])
  @@map("insurers")
}

model AlaraOffice {
  id         BigInt    @id @default(autoincrement())
  name       String    @db.VarChar(200)
  timezone   String    @db.VarChar(64)
  is_active  Boolean   @default(true)
  created_at DateTime  @default(now())
  updated_at DateTime? @updatedAt

  users User[]

  @@unique([name])
  @@map("alara_offices")
}

model Role {
  id         BigInt   @id @default(autoincrement())
  code       String   @db.VarChar(50)
  name       String   @db.VarChar(120)
  created_at DateTime @default(now())

  user_roles UserRole[]

  @@unique([code])
  @@map("roles")
}

model User {
  id              BigInt    @id @default(autoincrement())
  user_type       UserType
  insurer_id      BigInt?
  alara_office_id BigInt?
  email           String    @unique @db.VarChar(255)
  phone           String?   @db.VarChar(30)
  full_name       String    @db.VarChar(200)
  password_hash   String    @db.VarChar(255)
  is_active       Boolean   @default(true)
  last_login_at   DateTime?
  created_at      DateTime  @default(now())
  updated_at      DateTime? @updatedAt

  insurer      Insurer?     @relation(fields: [insurer_id], references: [id])
  alara_office AlaraOffice? @relation(fields: [alara_office_id], references: [id])

  roles                  UserRole[]
  created_requests       InspectionRequest[]              @relation("created_requests")
  updated_requests       InspectionRequest[]              @relation("updated_requests")
  assigned_requests      InspectionRequest[]              @relation("assigned_requests")
  decided_requests       InspectionRequest[]              @relation("decided_requests")
  report_shared_requests InspectionRequest[]              @relation("report_shared_by")
  documents              Document[]
  investigations         Investigation[]
  reports                InspectionReport[]
  status_changes         InspectionRequestStatusHistory[]
  calendar_events        CalendarEvent[]
  notifications          Notification[]

  @@index([insurer_id])
  @@index([alara_office_id])
  @@map("users")
}

model UserRole {
  user_id BigInt
  role_id BigInt

  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)
  role Role @relation(fields: [role_id], references: [id], onDelete: Cascade)

  @@id([user_id, role_id])
  @@map("user_roles")
}

model Client {
  id              BigInt    @id @default(autoincrement())
  first_name      String    @db.VarChar(100)
  last_name       String    @db.VarChar(120)
  dob             DateTime? @db.Date
  id_type         IdType?
  id_number       String?   @db.VarChar(50)
  email           String?   @db.VarChar(255)
  phone_mobile    String?   @db.VarChar(30)
  phone_home      String?   @db.VarChar(30)
  phone_work      String?   @db.VarChar(30)
  employer_name   String?   @db.VarChar(200)
  employer_tax_id String?   @db.VarChar(50)
  profession      String?   @db.VarChar(150)
  created_at      DateTime  @default(now())
  updated_at      DateTime? @updatedAt

  addresses           ClientAddress[]
  insurer_clients     InsurerClient[]
  inspection_requests InspectionRequest[]
  documents           Document[]

  @@unique([id_type, id_number])
  @@index([last_name, first_name])
  @@map("clients")
}

model ClientAddress {
  id           BigInt      @id @default(autoincrement())
  client_id    BigInt
  address_type AddressType @default(HOME)
  country      String?     @db.VarChar(80)
  city         String?     @db.VarChar(120)
  address_line String?     @db.VarChar(255)
  created_at   DateTime    @default(now())

  client Client @relation(fields: [client_id], references: [id], onDelete: Cascade)

  @@index([client_id])
  @@map("client_addresses")
}

model InsurerClient {
  id                 BigInt    @id @default(autoincrement())
  insurer_id         BigInt
  client_id          BigInt
  insurer_client_ref String?   @db.VarChar(80)
  notes              String?   @db.Text
  is_vip             Boolean   @default(true)
  created_at         DateTime  @default(now())
  updated_at         DateTime? @updatedAt

  insurer             Insurer             @relation(fields: [insurer_id], references: [id])
  client              Client              @relation(fields: [client_id], references: [id])
  inspection_requests InspectionRequest[]

  @@unique([insurer_id, client_id])
  @@index([client_id])
  @@map("insurer_clients")
}

model InspectionRequest {
  id                            BigInt           @id @default(autoincrement())
  insurer_id                    BigInt
  insurer_client_id             BigInt
  client_id                     BigInt
  request_number                String           @db.VarChar(60)
  agent_name                    String?          @db.VarChar(200)
  insured_amount                Decimal?         @db.Decimal(18, 2)
  has_amount_in_force           Boolean          @default(false)
  responsible_name              String           @db.VarChar(200)
  responsible_phone             String?          @db.VarChar(30)
  responsible_email             String?          @db.VarChar(255)
  marital_status                String?          @db.VarChar(50)
  comments                      String?          @db.Text
  client_notified               Boolean          @default(false)
  interview_language            String?          @db.VarChar(50)
  status                        InspectionStatus @default(SOLICITADA)
  assigned_investigator_user_id BigInt?
  assigned_at                   DateTime?
  requested_at                  DateTime         @default(now())
  scheduled_start_at            DateTime?
  scheduled_end_at              DateTime?
  completed_at                  DateTime?
  closed_at                     DateTime?
  priority                      Priority         @default(NORMAL)
  cancellation_reason           String?          @db.VarChar(255)
  insurer_decision              DecisionStatus   @default(PENDIENTE)
  insurer_decision_reason       String?          @db.VarChar(255)
  insurer_decision_notes        String?          @db.Text
  insurer_decided_by_user_id    BigInt?
  insurer_decided_at            DateTime?
  report_shared_at              DateTime?
  report_shared_by_user_id      BigInt?
  created_by_user_id            BigInt
  updated_by_user_id            BigInt?
  created_at                    DateTime         @default(now())
  updated_at                    DateTime?        @updatedAt

  insurer               Insurer       @relation(fields: [insurer_id], references: [id])
  client                Client        @relation(fields: [client_id], references: [id])
  insurer_client        InsurerClient @relation(fields: [insurer_client_id], references: [id])
  created_by            User          @relation("created_requests", fields: [created_by_user_id], references: [id])
  updated_by            User?         @relation("updated_requests", fields: [updated_by_user_id], references: [id])
  assigned_investigator User?         @relation("assigned_requests", fields: [assigned_investigator_user_id], references: [id])
  decided_by            User?         @relation("decided_requests", fields: [insurer_decided_by_user_id], references: [id])
  report_shared_by      User?         @relation("report_shared_by", fields: [report_shared_by_user_id], references: [id])

  status_history    InspectionRequestStatusHistory[]
  calendar_events   CalendarEvent[]
  documents         Document[]
  inspection_report InspectionReport?
  investigations    Investigation[]
  workflow_runs     WorkflowRun[]
  notifications     Notification[]
  call_recordings   CallRecording[]

  @@unique([insurer_id, request_number])
  @@index([status])
  @@index([insurer_id])
  @@index([client_id])
  @@index([insurer_client_id])
  @@index([assigned_investigator_user_id])
  @@index([scheduled_start_at])
  @@map("inspection_requests")
}

model CallRecording {
  id                    BigInt   @id @default(autoincrement())
  inspection_request_id BigInt?
  recording_sid         String   @db.VarChar(64)
  call_sid              String?  @db.VarChar(64)
  recording_url         String   @db.VarChar(1024)
  recording_duration    Int?
  created_at            DateTime @default(now())

  inspection_request InspectionRequest? @relation(fields: [inspection_request_id], references: [id], onDelete: SetNull)

  @@index([inspection_request_id])
  @@index([recording_sid])
  @@index([call_sid])
  @@map("call_recordings")
}

model InspectionRequestStatusHistory {
  id                    BigInt            @id @default(autoincrement())
  inspection_request_id BigInt
  old_status            InspectionStatus?
  new_status            InspectionStatus
  note                  String?           @db.VarChar(255)
  changed_by_user_id    BigInt
  changed_at            DateTime          @default(now())

  inspection_request InspectionRequest @relation(fields: [inspection_request_id], references: [id], onDelete: Cascade)
  changed_by         User              @relation(fields: [changed_by_user_id], references: [id])

  @@index([inspection_request_id])
  @@index([changed_at])
  @@map("inspection_request_status_history")
}

model CalendarEvent {
  id                    BigInt           @id @default(autoincrement())
  inspection_request_id BigInt
  investigator_user_id  BigInt
  provider              CalendarProvider @default(INTERNAL)
  provider_event_id     String?          @db.VarChar(200)
  title                 String           @db.VarChar(200)
  description           String?          @db.Text
  start_at              DateTime
  end_at                DateTime
  location              String?          @db.VarChar(200)
  status                CalendarStatus   @default(CONFIRMED)
  created_at            DateTime         @default(now())
  updated_at            DateTime?        @updatedAt

  inspection_request InspectionRequest @relation(fields: [inspection_request_id], references: [id], onDelete: Cascade)
  investigator       User              @relation(fields: [investigator_user_id], references: [id])

  @@index([inspection_request_id])
  @@index([investigator_user_id])
  @@index([provider, provider_event_id])
  @@index([start_at])
  @@map("calendar_events")
}

model Document {
  id                    BigInt          @id @default(autoincrement())
  insurer_id            BigInt
  inspection_request_id BigInt?
  client_id             BigInt?
  doc_type              DocumentType
  filename              String          @db.VarChar(255)
  mime_type             String          @db.VarChar(80)
  file_size_bytes       BigInt
  storage_provider      StorageProvider @default(S3)
  storage_key           String          @db.VarChar(512)
  storage_url           String?         @db.VarChar(1024)
  sha256                String?         @db.Char(64)
  uploaded_by_user_id   BigInt
  uploaded_at           DateTime        @default(now())

  insurer            Insurer            @relation(fields: [insurer_id], references: [id])
  inspection_request InspectionRequest? @relation(fields: [inspection_request_id], references: [id], onDelete: Cascade)
  client             Client?            @relation(fields: [client_id], references: [id], onDelete: SetNull)
  uploaded_by        User               @relation(fields: [uploaded_by_user_id], references: [id])

  @@index([insurer_id])
  @@index([inspection_request_id])
  @@index([client_id])
  @@index([doc_type])
  @@map("documents")
}

model InspectionReport {
  id                    BigInt        @id @default(autoincrement())
  inspection_request_id BigInt
  created_by_user_id    BigInt
  interview_started_at  DateTime?
  interview_ended_at    DateTime?
  concluded_at          DateTime?
  summary               String?       @db.Text
  additional_comments   String?       @db.Text
  outcome               ReportOutcome @default(PENDIENTE)
  created_at            DateTime      @default(now())
  updated_at            DateTime?     @updatedAt

  inspection_request InspectionRequest @relation(fields: [inspection_request_id], references: [id], onDelete: Cascade)
  created_by         User              @relation(fields: [created_by_user_id], references: [id])
  sections           ReportSection[]

  @@unique([inspection_request_id])
  @@map("inspection_reports")
}

model ReportSection {
  id                   BigInt   @id @default(autoincrement())
  inspection_report_id BigInt
  section_code         String   @db.VarChar(60)
  section_title        String   @db.VarChar(120)
  section_order        Int      @default(0)
  created_at           DateTime @default(now())

  inspection_report InspectionReport @relation(fields: [inspection_report_id], references: [id], onDelete: Cascade)
  fields            ReportField[]

  @@unique([inspection_report_id, section_code])
  @@map("report_sections")
}

model ReportField {
  id                BigInt          @id @default(autoincrement())
  report_section_id BigInt
  field_key         String          @db.VarChar(80)
  field_label       String?         @db.VarChar(150)
  field_type        ReportFieldType @default(TEXT)
  field_value       String?         @db.Text
  created_at        DateTime        @default(now())

  report_section ReportSection @relation(fields: [report_section_id], references: [id], onDelete: Cascade)

  @@unique([report_section_id, field_key])
  @@map("report_fields")
}

model ReportTemplate {
  id         BigInt    @id @default(autoincrement())
  code       String    @unique @db.VarChar(80)
  name       String    @db.VarChar(120)
  payload    Json
  created_at DateTime  @default(now())
  updated_at DateTime? @updatedAt

  @@map("report_templates")
}

model Investigation {
  id                    BigInt              @id @default(autoincrement())
  inspection_request_id BigInt
  created_by_user_id    BigInt
  source_type           InvestigationSource @default(OTHER)
  source_name           String?             @db.VarChar(200)
  finding_summary       String              @db.Text
  risk_level            RiskLevel           @default(BAJO)
  is_adverse_record     Boolean             @default(false)
  created_at            DateTime            @default(now())

  inspection_request InspectionRequest @relation(fields: [inspection_request_id], references: [id], onDelete: Cascade)
  created_by         User              @relation(fields: [created_by_user_id], references: [id])

  @@index([inspection_request_id])
  @@map("investigations")
}

model WorkflowRun {
  id                    BigInt           @id @default(autoincrement())
  inspection_request_id BigInt
  provider              WorkflowProvider @default(N8N)
  external_run_id       String?          @db.VarChar(200)
  status                WorkflowStatus   @default(STARTED)
  request_payload       Json?
  response_payload      Json?
  error_message         String?          @db.Text
  started_at            DateTime         @default(now())
  finished_at           DateTime?

  inspection_request InspectionRequest @relation(fields: [inspection_request_id], references: [id], onDelete: Cascade)

  @@index([inspection_request_id])
  @@index([status])
  @@map("workflow_runs")
}

model Notification {
  id                    BigInt              @id @default(autoincrement())
  insurer_id            BigInt?
  inspection_request_id BigInt?
  recipient_user_id     BigInt?
  channel               NotificationChannel @default(IN_APP)
  template_code         String?             @db.VarChar(80)
  subject               String?             @db.VarChar(200)
  message               String              @db.Text
  status                NotificationStatus  @default(PENDING)
  provider_message_id   String?             @db.VarChar(200)
  error_message         String?             @db.Text
  created_at            DateTime            @default(now())
  sent_at               DateTime?

  insurer            Insurer?           @relation(fields: [insurer_id], references: [id])
  inspection_request InspectionRequest? @relation(fields: [inspection_request_id], references: [id], onDelete: Cascade)
  recipient          User?              @relation(fields: [recipient_user_id], references: [id], onDelete: SetNull)

  @@index([inspection_request_id])
  @@index([recipient_user_id])
  @@index([status])
  @@map("notifications")
}
